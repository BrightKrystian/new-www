{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blog/redshift-materialized-views","result":{"data":{"markdownRemark":{"html":"<p>It is often convenient to create a view upon your normalized schema to join and aggregate the data, especially when it requires a complicated query.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9a5cff008b97ee49bf94842e894df467/c08c5/image1.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.08108108108109%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAUC/8QAFAEBAAAAAAAAAAAAAAAAAAAAAv/aAAwDAQACEAMQAAABykZCoJ5j/8QAGxAAAQQDAAAAAAAAAAAAAAAAAAEDERICE0H/2gAIAQEAAQUCs06a64wcklT/xAAXEQEAAwAAAAAAAAAAAAAAAAAAAREh/9oACAEDAQE/AcVD/8QAGBEAAgMAAAAAAAAAAAAAAAAAAAESIUH/2gAIAQIBAT8BvGSZ/8QAGRABAAIDAAAAAAAAAAAAAAAAAQAhICJx/9oACAEBAAY/Ar1ZSJ3H/8QAGhAAAgMBAQAAAAAAAAAAAAAAAAERITFhsf/aAAgBAQABPyFag2JYGk36Rsklp2P/2gAMAwEAAgADAAAAELP/AP/EABgRAAIDAAAAAAAAAAAAAAAAAAABETFh/9oACAEDAQE/EJa0YH//xAAWEQADAAAAAAAAAAAAAAAAAAABECH/2gAIAQIBAT8Qkov/xAAZEAEBAQEBAQAAAAAAAAAAAAABEQAhYXH/2gAIAQEAAT8Ql9QVXg56jd4KOsUL4DAUisxEGH3ejf/Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"publish\"\n        title=\"publish\"\n        src=\"/static/9a5cff008b97ee49bf94842e894df467/1c72d/image1.jpg\"\n        srcset=\"/static/9a5cff008b97ee49bf94842e894df467/a80bd/image1.jpg 148w,\n/static/9a5cff008b97ee49bf94842e894df467/1c91a/image1.jpg 295w,\n/static/9a5cff008b97ee49bf94842e894df467/1c72d/image1.jpg 590w,\n/static/9a5cff008b97ee49bf94842e894df467/c08c5/image1.jpg 640w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>In PostgreSQL you can create a view basing on a query.</p>\n<pre><code class=\"language-sql\">CREATE VIEW my_view AS SELECT\n                         list_id,\n                         event_id,\n                         sum(price_paid) AS revenue,\n                         count(qty_sold) AS qty\n                       FROM sales\n                         WHERE local_date >= '2018-01-01'\n                       GROUP BY list_id, event_id;\n</code></pre>\n<p>Each time you select the data from such a view, the query underneath will be executed. If the query takes a long time to execute, a materialized view might be used.</p>\n<pre><code class=\"language-sql\">CREATE MATERIALIZED VIEW my_view AS SELECT (...) ;\n</code></pre>\n<p>This view is populated with data at the time of creation, therefore there is no need to run the time consuming query each time you access the data. However, each time the data changes, the view needs to be refreshed manually with <code>REFRESH MATERIALIZED VIEW my_view</code> query. The materialized view is especially useful when your data changes infrequently and predictably. A perfect use case is an ETL process - the refresh query might be run as a part of it.</p>\n<p>As Redshift is based on PostgreSQL, one might expect Redshift to have materialized views. Unfortunately, Redshift does not implement this feature. Regular views in Redshift have two main disadvantages:</p>\n<ul>\n<li>the Redshift query planner does not optimize through views; therefore fetching data from a view instead of running the query directly may actually be slower,</li>\n<li>the views in Redshift are connected to the table (not just its name), so you will encounter errors while altering the table; using <code>WITH NO SCHEMA BINDING</code> clause tells Redshift not to bound to the underlying database objects.</li>\n</ul>\n<p>Instead of using a view, we can create a table basing on a query (and drop and recreate it each time). As it is a regular table, it’s possible to define sort keys to further improve the performance.</p>\n<p>The ease of data refresh might be reckoned as an advantage of a materialized view. To achieve a similar behaviour with table, we can use a regular view to actually store the query. The downside of such a solution is that inserting data into the table through the view will take longer than with the query. Recreating a table with data through a view could be as simple as the two following statements wrapped into a transaction block:</p>\n<pre><code class=\"language-sql\">BEGIN TRANSACTION;\nDROP TABLE my_view_table;\nCREATE TABLE my_view_table AS SELECT * FROM my_view;\nCOMMIT TRANSACTION;\n</code></pre>\n<p>This piece of code has two main issues:</p>\n<ul>\n<li><code>DROP</code> command in transaction puts a <code>LOCK</code> on the table, so other processes will need to wait, when trying to access the data; moreover, if you commit the transaction, the process awaiting will receive an error like <code>table 1234556 dropped by concurrent transaction</code>,</li>\n<li>any sort key added to the table will be lost.</li>\n</ul>\n<p>Deleting all data from the table, although seems easy to implement, requires <code>VACUUM</code> and <code>ANALYZE</code> which might be quite long. A faster alternative to an unqualified <code>DELETE</code> is <code>TRUNCATE</code>. However, it commits the transaction in which it is run and cannot be rolled back. Another way is to use the <code>CREATE TABLE ... LIKE</code> statement to create an intermediate table. This statement copies column names, data types and <code>NOT NULL</code> constraints. Tables created with the <code>LIKE</code> option also inherit distribution style and sort keys (but do not inherit primary and foreign key constraints).</p>\n<pre><code class=\"language-sql\">BEGIN TRANSACTION;\nCREATE TABLE my_view_table_new LIKE my_view_table;\nINSERT INTO my_view_table_new SELECT * FROM my_view;\nALTER TABLE RENAME my_view_table TO my_view_table_old;\nALTER TABLE RENAME my_view_table_new TO my_view_table;\nDROP TABLE my_view_table_old;\nCOMMIT;\nEND TRANSACTION;\n</code></pre>\n<p>To see the code of the query used to create the view you can log into the database with <code>psql</code> and run <code>\\d+ my_view</code>.</p>\n<p>Redshift does not implement materialized views, but it is quite straightforward to simulate a similar behaviour. The only question to ask is if we need the data refresh to be rather simpler or faster.</p>","excerpt":"It is often convenient to create a view upon your normalized schema to join and aggregate the data, especially when it requires a…","frontmatter":{"slug":null,"title":"Redshift Materialized Views","description":null,"author":"agnieszka","tags":["redshift"],"date":"2018-02-05T23:00:00.000Z","image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#181808","images":{"fallback":{"src":"/static/9a5cff008b97ee49bf94842e894df467/3440d/image1.jpg","srcSet":"/static/9a5cff008b97ee49bf94842e894df467/e51a0/image1.jpg 160w,\n/static/9a5cff008b97ee49bf94842e894df467/b4dad/image1.jpg 320w,\n/static/9a5cff008b97ee49bf94842e894df467/3440d/image1.jpg 640w","sizes":"(min-width: 640px) 640px, 100vw"},"sources":[{"srcSet":"/static/9a5cff008b97ee49bf94842e894df467/67032/image1.webp 160w,\n/static/9a5cff008b97ee49bf94842e894df467/c0bcc/image1.webp 320w,\n/static/9a5cff008b97ee49bf94842e894df467/17574/image1.webp 640w","type":"image/webp","sizes":"(min-width: 640px) 640px, 100vw"}]},"width":640,"height":360}}}},"timeToRead":3,"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2018-02-06-redshift-materialized-views.md"},"site":{"siteMetadata":{"siteUrl":"https://brightinventions.pl"}}},"pageContext":{"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2018-02-06-redshift-materialized-views.md"}},"staticQueryHashes":["2189233960","3181594896"]}