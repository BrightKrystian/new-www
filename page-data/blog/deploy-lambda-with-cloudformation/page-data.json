{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blog/deploy-lambda-with-cloudformation","result":{"data":{"markdownRemark":{"html":"<p>Serverless deployments are popular these days. With a minimal cost you can have your own code wait and respond to various events. AWS Lambda, Azure Functions are just 2 examples of serverless offering from the biggest cloud providers. For a long time I had thought about them only in the context of ad-hoc setups not suitable for a long term development. This was until I found out that you can, with a little effort, version and deploy the serverless API just as a traditional back-end. In this post I am going to show how to deploy AWS Lambda functions with the help of the tool <a href=\"https://adambar.pl/\">Adam</a> created at <a href=\"https://brightinventions.pl/\">Bright Inventions</a> called <a href=\"https://github.com/bright/cloudform\">cloudform</a>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/54e244bcba02c336b0120b27ecca2cc4/e628c/lambda.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 103.37837837837837%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAACoUlEQVQ4y5VUO2hUQRR9u5sfkmCy974NEiyiWIg2Ym0tqGhhJWJjq5WKH/LuxE+RQlAEawULCxGEVBaiFoq930ohjWBjEWNi7tlk5c7ct09Ww5oHwzzemzlzzj1nbpb5A6EGhGy+DaEOAgPCbQ3UgfBHSD6MIs8gHEffR4UaKmTzLQPRQKsaaE0Dt+MBwsccrAFp9QeE0IAzvAvhTjk0EJzlEw2UaWjWDRBhsh8g15zBbmdzAMKvnO06hFcgvMvX1FSafQH/NU6bXA0GFlkGL0tjM4DGdNDfd0B40Vka4CcUraFNmZPqOBVrpaFpm54nQF51lkcqc/L/YRmNqfu8B0I/NESD1Fk+NrmVOds2BtPZZpqvU6ZXI+BLB7NMrjvgTwjvrMyZ2FiqJlZlfM66IfA8rqewR9CZrjnFRIbZqV6wvFfqNIQWjV0V7Ahe3pwPkNZglNxrjn2MxS9MMtUsvBCad6krCYAeQng+vgdWZ3moMof/lqqV1FPORhMofUfBW5K78fsvTYCP0s0xVXkl252tOVgLQt9cqjOhk85kK4Q//5HJJQhPV9nNY+kyC6md4lIfuKzlUqqzGEqG8ZymTrTiLC+7uuFUz1bqMs7uqLetUupXCOfpHw84k70WIQ285izfa5hwlZNDkNZIhoJsjEHoS4/U435QQ4tRM67mN+ep35wyQpcgfAPCRuBMpiHW8E6SQEsu9X634Be3ZxpGu25C+IS3tXbMphkl3bo+swWH04I0ILSAgsYjczOrYM9p2d7yMQgvxPVCmoBjqQxw2TbdU6F3EHoNobcQOuhRKmvbveNlV4fwTTfFRhvCbyA8C+H9GWbGR3BhsI4rowM416ghsJWhZqXwzVlnrZ2AQ15HyG3eh8AvIHzeGvLqtay79jdVWKn0rUjV4QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Lambda function\"\n        title=\"Lambda function\"\n        src=\"/static/54e244bcba02c336b0120b27ecca2cc4/fcda8/lambda.png\"\n        srcset=\"/static/54e244bcba02c336b0120b27ecca2cc4/12f09/lambda.png 148w,\n/static/54e244bcba02c336b0120b27ecca2cc4/e4a3f/lambda.png 295w,\n/static/54e244bcba02c336b0120b27ecca2cc4/fcda8/lambda.png 590w,\n/static/54e244bcba02c336b0120b27ecca2cc4/e628c/lambda.png 619w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Step 1: Define a template</h2>\n<p>Let's install the <a href=\"https://github.com/bright/cloudform\">cloudform</a> <code>npm i --save-dev cloudform</code> and define a minimal template:</p>\n<pre><code class=\"language-typescript\">import cloudform, { Lambda, IAM, Fn } from 'cloudform';\n\nconst LambdaExecutionRole = 'LambdaExecutionRole';\n\ncloudform({\n    Resources: {\n        HelloWorld: new Lambda.Function({\n            Code: {\n                ZipFile: \"exports.wrtiteToConsole = function (event, context, callback){ console.log('Hello'); callback(null); }\"\n            },\n            Handler: \"index.wrtiteToConsole\",\n            Role: Fn.GetAtt(LambdaExecutionRole, \"Arn\"),\n            Runtime: \"nodejs6.10\"\n        }),\n        [LambdaExecutionRole]: new IAM.Role({\n            AssumeRolePolicyDocument: {\n                Statement: [{\n                    Effect: \"Allow\",\n                    Principal: { Service: [\"lambda.amazonaws.com\"] },\n                    Action: [\"sts:AssumeRole\"]\n                }]\n            },\n            Path: \"/\",\n            ManagedPolicyArns: [\"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole\"]\n        })\n    }\n});\n</code></pre>\n<p>There are only 2 resources defined in the template.  <code>HelloWorld</code> is the AWS Lambda function definition. We have set the <code>Runtime</code> property to use <code>nodejs6.10</code> hence the <code>Code.ZipFile</code> contains a JavaScript code. Despite the name <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-lambda-function-code.html#cfn-lambda-function-code-zipfile\"><code>ZipFile</code></a> should contain application source code in plain text. Obviously the <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-lambda-function-code.html\"><code>ZipFile</code></a> may only be used for the most simple functions. The <code>S3Bucket</code> and <code>S3Key</code> properties can be used to deploy a more involved function implementation. The <code>Handler</code> defines which function from <code>Code</code> the Lambda runtime should invoke. In case of <code>ZipFile</code> the first part is always <code>index</code>. </p>\n<p>The <code>Role</code> is a required setting for every AWS Lambda function. It defines what entitlements the code invoked by the Lambda runtime has. In the above template we define a policy which can be assumed by <code>lambda.amazonaws.com</code> and references a pre-defined AWS managed policy <a href=\"https://docs.aws.amazon.com/lambda/latest/dg/intro-permission-model.html\"><code>AWSLambdaBasicExecutionRole</code></a>. The <code>AWSLambdaBasicExecutionRole</code> makes it possible for the Lambda function logs to be pushed to Cloud Watch.</p>\n<h2>Step 2: Create the AWS Lambda function</h2>\n<p>Deploying our Lambda function using CloudFormation requires a single command:</p>\n<pre><code class=\"language-bash\">aws cloudformation create-stack \\\n    --capabilities CAPABILITY_IAM \\\n    --stack-name lambda-example \\\n    --template-body file://&#x3C;(node_modules/.bin/cloudform aws-template.ts)\n</code></pre>\n<p>The <code>--capabilities CAPABILITY_IAM</code> is required whenever the CloudFormation has to define Roles, Policies or related resources. The <code>--template-body file://&#x3C;(node_modules/.bin/cloudform aws-template.ts)</code> instructs CloudFormation to use a template defined in a file. The <code>&#x3C;(...)</code> is <a href=\"https://superuser.com/questions/1059781/what-exactly-is-in-bash-and-in-zsh\">bash and zsh way to pass an output of a command</a> to other program as if the output was a file. After waiting a bit for the invocation to complete we will see the following in the AWS Console:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/db231600f8b624947a1b37ee4784ae95/ca3c3/aws-console.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 78.37837837837837%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAACmklEQVQ4y4VUyZKkNhDlk/1HvvonfPLJPjh6HDG9uaq7qCoaAZKQEJIQAt5EZtE9y2EmI15IKFO5PlF8vn/A/cMjHp+ecffpPzw8PsFYi/PlivJyge4NqrcatWh4r/oeUmv01sKNI7qug1AG/V+/o//jNxRSKfx/OEA0DUIIGL1HjBHTNH0gvu9jZF2c4nc2rA8jgjMovA9QSrMzkmVZeJ+mhDll5HlHmpFXYFmBdVmxrRvWZbvZkG5ekFJGobRGeb5ANC1HWtcVhkrTPXLKWNJyWxegLQ94fTniWHV4PlU4XASMn7HOC5aUMU8zCipxcCNGH+C8R84Zgx2wkNG3yBtkK3D3+R5//n2HT4cz7ssamhzmmw0FLvq+R9t2nBnJtm2wxiLF9AMmSL/gqCOexICjntD4DO0i5pgwxYQY4s2hlArjOHJ25NA5h8E6KKnRa/MBOsvTzNlMIeLx9O9t8kqhaVp0nURh7QAhBDopeSDkkIbAJezrt+B+7quUElr30NrAmoEDFsPguOSUEt5lyZkv/Aq9MhB1g66V8M7DjwEFkbjvDewwwHuPECOMsUxYKuFnoFKJcpTlOHrmcFELgcPxBa+nExrVs0PiYdhJzN8x7OtXxN3Ok20IH98FKTmzEDDvQ6FeEuY58/R/BOtyxrpt3KL3MxpqQRHeasFv9eZk/uglDYoITxfImECS0ozztULdKRBLMrF+lyJyzwwraOLUU6bNMKA39GI0nBtBw6NzqoYoZq3d7xkMzvHESV/QH6PtOpyubzifzyjLEtfrlalUnl7Rtg0GZzH6mzM/jozAbdrhA5qm4aQKjmQtpHGoqoqjOjegqlv886xxOHV4OdZ4LQWEVKilglAaVdvh2lq8NQpVe0XT3hx+Af0EydywnS8HAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"AWS Lambda Screen\"\n        title=\"AWS Lambda Screen\"\n        src=\"/static/db231600f8b624947a1b37ee4784ae95/fcda8/aws-console.png\"\n        srcset=\"/static/db231600f8b624947a1b37ee4784ae95/12f09/aws-console.png 148w,\n/static/db231600f8b624947a1b37ee4784ae95/e4a3f/aws-console.png 295w,\n/static/db231600f8b624947a1b37ee4784ae95/fcda8/aws-console.png 590w,\n/static/db231600f8b624947a1b37ee4784ae95/efc66/aws-console.png 885w,\n/static/db231600f8b624947a1b37ee4784ae95/c83ae/aws-console.png 1180w,\n/static/db231600f8b624947a1b37ee4784ae95/ca3c3/aws-console.png 1850w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>It is possible to use the AWS Console editor to test and change the function. However, if we are to treat the serverless approach seriously we should not forget about the standard practices like versioning of our source code.</p>\n<h2>Step 3: Update and version AWS Lambda function</h2>\n<p>Since we have defined the AWS Lambda function using a cloudform template we can version it as any other code. The whole serverless infrastructure we use and configure is treated as a source code allowing for an easy replication of deployment environments, audit trail and change management. Let's see how we can use cloudform to add another function that will be called by the first one.</p>\n<pre><code class=\"language-typescript\">import cloudform, { Lambda, IAM, Fn } from 'cloudform';\nimport { FunctionProperties } from 'cloudform/types/lambda/function';\nimport { readFileSync } from 'fs';\n\nconst\n    LambdaExecutionRole = 'LambdaExecutionRole',\n    Alice = 'Alice',\n    Bob = 'Bob';\n\nfunction lambdaFunction(\n    functionCode: string,\n    options?: Partial&#x3C;FunctionProperties>) {\n    return new Lambda.Function({\n        Code: { ZipFile: functionCode },\n        Handler: \"index.main\",\n        Role: Fn.GetAtt(LambdaExecutionRole, \"Arn\"),\n        Runtime: \"nodejs6.10\",\n        ...options\n    });\n}\n\nexport default cloudform({\n    Resources: {\n        [Alice]: lambdaFunction(readFileSync('Alice.js', 'utf-8'), {\n            Environment: {\n                Variables: {\n                    BobFunction: Fn.GetAtt(Bob, \"Arn\")\n                }\n            }\n        }),\n        [Bob]: lambdaFunction(readFileSync('Bob.js', 'utf-8')),\n        ... // LambdaExecutionRole see below\n    }\n})\n</code></pre>\n<p>As you can see above, we've extracted a function <code>lambdaFunction</code> to simplify Lambda function declaration. Both <code>Alice</code> and <code>Bob</code> function's bodies are defined in separate files. Interestingly  <code>Alice</code> function, during the invocation, will have access to <code>BobFunction</code> environment variable pointing to <code>Bob</code> function <a href=\"https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html\">ARN</a>.</p>\n<p>Our <code>LambdaExecutionRole</code> lacks a permission to invoke another Lambda function. Let's fix that:</p>\n<pre><code class=\"language-typescript\">    [LambdaExecutionRole]: new IAM.Role({\n        AssumeRolePolicyDocument: {\n            Statement: [{\n                Effect: \"Allow\",\n                Principal: { Service: [\"lambda.amazonaws.com\"] },\n                Action: [\"sts:AssumeRole\"]\n            }]\n        },\n        Path: \"/\",\n        ManagedPolicyArns: [\"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole\"],\n        Policies: [{\n            PolicyName: \"AllowCallingOtherLambda\",\n            PolicyDocument: {\n                Version: \"2012-10-17\",\n                Statement: [{\n                    Sid: \"InvokeLambdaPermission\",\n                    Effect: \"Allow\",\n                    Action: [\"lambda:InvokeFunction\"],\n                    Resource: \"*\"\n                }]\n            }\n        }]\n    })\n</code></pre>\n<p>The <code>Alice</code> and <code>Bob</code> sources export <code>main</code> functions invoked by AWS Lambda runtime:</p>\n<pre><code class=\"language-typescript\">// Alice.ts\nimport aws from 'aws-sdk';\n\nexport function main(event: any, context: any, callback: Function) {\n    new aws.Lambda().invoke({\n        FunctionName: process.env.BobFunction!,\n        Payload: JSON.stringify({message: \"Hi!. I'm Alice.\"})\n    }, (error: Error, data: any) => {\n        const response = JSON.parse(data.Payload);\n        console.log('FromBob', error || response)\n        callback(error);\n    });\n}\n\n// Bob.ts\nexport function main(event: any, context: any, callback: any) {\n    console.log('FromAlice', event)\n    callback(null, {message: \"Hi! I'm Bob. Nice to meet you!\"});\n}\n</code></pre>\n<p>Since we now use TypeScript for <code>Alice</code> and <code>Bob</code> source we need to install the compiler <code>npm i --save-dev typescript @types/node aws-sdk</code>. Unfortunately currently in <a href=\"https://github.com/bright/cloudform\">cloudform</a> it is not possible to use custom <code>tsconfig.json</code> for the compilation. Fortunately we can invoke the compiler manually and use its outputs as any other Node.js source code. With a <code>tsconfig.json</code>:</p>\n<pre><code class=\"language-json\">{\n  \"compilerOptions\": {\n    \"module\": \"commonjs\",\n    \"target\": \"es6\",\n    \"strict\": true, \n    \"strictPropertyInitialization\": false,\n    \"esModuleInterop\": true\n  },\n  \"exclude\": [\"node_modules\"],\n  \"compileOnSave\": true\n}\n</code></pre>\n<p>we can use the following commands to compile and deploy Lambda functions:</p>\n<pre><code class=\"language-bash\">./node_modules/.bin/tsc\n\naws cloudformation update-stack \\\n    --capabilities CAPABILITY_IAM \\\n    --stack-name lambda-example \\\n    --template-body file://&#x3C;(node -e \"console.log((require('./aws-template').default))\")\n</code></pre>\n<p>After the stack update completes we now should have 2 Lambda functions available. When we invoke the <code>Alice</code> function, we'll see that the 2 AWS Lambda functions communicate:</p>\n<pre><code>START RequestId: 6a87c764-251e-11e8-b921-f9ca7649c7d7 Version: $LATEST\n2018-03-11T11:22:00.615Z    6a87c764-251e-11e8-b921-f9ca7649c7d7    Alice says: Hi!. I'm Alice.\n2018-03-11T11:22:01.676Z    6a87c764-251e-11e8-b921-f9ca7649c7d7    Bob says: Hi! I'm Bob. Nice to meet you!\nEND RequestId: 6a87c764-251e-11e8-b921-f9ca7649c7d7\nREPORT RequestId: 6a87c764-251e-11e8-b921-f9ca7649c7d7  Duration: 1110.68 ms    Billed Duration: 1200 ms    Memory Size: 128 MB Max Memory Used: 34 MB  \n</code></pre>\n<p>Serverless infrastructure offers endless possibilities. With <a href=\"https://github.com/bright/cloudform\">cloudform</a> we can take AWS Lambda development, change management and deployment to the next level.</p>","excerpt":"Serverless deployments are popular these days. With a minimal cost you can have your own code wait and respond to various events. AWS Lambda…","frontmatter":{"slug":null,"title":"How to deploy Lambda function with CloudFormation?","description":null,"author":"piotr","tags":["aws","cloudformation","lambda","cloudform"],"date":"2018-03-11T23:00:00.000Z","image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#f8f8f8","images":{"fallback":{"src":"/static/54e244bcba02c336b0120b27ecca2cc4/ebc99/lambda.png","srcSet":"/static/54e244bcba02c336b0120b27ecca2cc4/54856/lambda.png 155w,\n/static/54e244bcba02c336b0120b27ecca2cc4/b4172/lambda.png 310w,\n/static/54e244bcba02c336b0120b27ecca2cc4/ebc99/lambda.png 619w","sizes":"(min-width: 619px) 619px, 100vw"},"sources":[{"srcSet":"/static/54e244bcba02c336b0120b27ecca2cc4/3f69d/lambda.webp 155w,\n/static/54e244bcba02c336b0120b27ecca2cc4/1333e/lambda.webp 310w,\n/static/54e244bcba02c336b0120b27ecca2cc4/ea24c/lambda.webp 619w","type":"image/webp","sizes":"(min-width: 619px) 619px, 100vw"}]},"width":619,"height":640}}}},"timeToRead":6,"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2018-03-12-deploy-lambda-with-cloudformation.md"},"site":{"siteMetadata":{"siteUrl":"https://brightinventions.pl"}}},"pageContext":{"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2018-03-12-deploy-lambda-with-cloudformation.md"}},"staticQueryHashes":["2189233960","3181594896"]}