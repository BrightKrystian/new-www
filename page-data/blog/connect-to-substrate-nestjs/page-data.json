{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blog/connect-to-substrate-nestjs","result":{"data":{"markdownRemark":{"html":"<h2>Create a sample NestJS project</h2>\n<p>First of all, we should create a NestJS project.\nPlease use the <a href=\"https://github.com/nestjs/nest-cli\">nest-cli</a> to generate the project template:</p>\n<pre><code>nest new substrate-nests\ncd substrate-nests\n</code></pre>\n<p>This commands generate for us a sample project with one module and generate code for one GET API endpoint:</p>\n<pre><code class=\"language-sh\">src\n├── app.controller.spec.ts\n├── app.controller.ts\n├── app.module.ts\n├── app.service.ts\n└── main.ts\n</code></pre>\n<p>After you successfully create the sample project you could run the dev server:</p>\n<pre><code>yarn start:dev\n</code></pre>\n<p>This command runs dev server and now you can see text <em>Hello World!</em> if you open <a href=\"http://localhost:3000/\">http://localhost:3000/</a>.</p>\n<h2>Connecting to substrate</h2>\n<h3>Preparation</h3>\n<p>To connect to the substrate node we will be using the library <a href=\"https://github.com/polkadot-js\">polkadot-js</a>.\nPlease, add this library to dependency:</p>\n<pre><code class=\"language-sh\">yarn add @polkadot/api\n</code></pre>\n<p>To work with this library please set flag <code>esModuleInterop</code> to <code>true</code> in <code>tsconfig.json</code> file and restart the dev server.</p>\n<p>Now you can add necessary imports to <code>app.service.ts</code> file:</p>\n<pre><code>import { ApiPromise, WsProvider, Keyring } from '@polkadot/api';\n</code></pre>\n<p>The next thing we should set is the URL where our node exists.\nPlease add these lines after the import section in <code>app.service.ts</code> file:</p>\n<pre><code>const SUBSTRATE_URL = 'wss://dev-node.substrate.dev:9944'; // dev node of substrate blockchain\n// const SUBSTRATE_URL = 'ws://127.0.0.1:9944'; // if you have substrate install locally you can use this address\n</code></pre>\n<p>We are going to connect to the substrate node in <code>onModuleInit</code> lifecycle function. It allows us to connect to the node after module initialized.</p>\n<pre><code>@Injectable()\nexport class AppService implements OnModuleInit { // class should implement OnModuleInit interface\n  private api: ApiPromise;\n\n  // please, add this function to your class\n  async onModuleInit() {\n    Logger.log('Connecting to substrate chain...');\n    const wsProvider = new WsProvider(SUBSTRATE_URL);\n    this.api = await ApiPromise.create({ provider: wsProvider });\n  }\n</code></pre>\n<p>After the restart you could see our message in logs:</p>\n<pre><code>[Nest] 6701   - 04/07/2020, 1:21:02 PM   [NestFactory] Starting Nest application...\n[Nest] 6701   - 04/07/2020, 1:21:02 PM   [InstanceLoader] AppModule dependencies initialized +13ms\n[Nest] 6701   - 04/07/2020, 1:21:02 PM   [RoutesResolver] AppController {/}: +5ms\n[Nest] 6701   - 04/07/2020, 1:21:02 PM   [RouterExplorer] Mapped {/, GET} route +2ms\n[Nest] 6701   - 04/07/2020, 1:21:02 PM   Connecting to substrate chain... +1ms\n</code></pre>\n<h3>Getting data</h3>\n<p>For the test purposes, we will get the chain name, node name, version, the number of the latest block and the current timestamp.\nFor this let's create the new function in <code>AppService</code> class:</p>\n<pre><code>async getSimpleData() {\n  await this.api.isReady;\n}\n</code></pre>\n<p>The first line in the function <code>getSimpleData</code> waits until our connection to substrate node will be ready.</p>\n<p>Now we can add code to get the data:</p>\n<pre><code>async getSimpleData() {\n  await this.api.isReady;\n\n  const chain = await this.api.rpc.system.chain();\n  const nodeName = this.api.rpc.system.name();\n  const nodeVersion = this.api.rpc.system.version();\n  const header = this.api.rpc.chain.getHeader();\n  const now = await this.api.query.timestamp.now();\n\n  return {\n    chain,\n    nodeName,\n    nodeVersion,\n    headerNumber: header.number,\n    now\n  };\n}\n</code></pre>\n<p>After we create this function we could change our endpoint's code to respond with this data.\nPlease update the function <code>getHello</code> in <code>AppController</code> with this code:</p>\n<pre><code>@Get()\nasync getHello(): Promise&#x3C;string> {\n  const data = await this.appService.getSimpleData();\n\n  return `\n    Chain: ${data.chain}&#x3C;br/>\n    Node name: ${data.nodeName}&#x3C;br/>\n    Node version: ${data.nodeVersion}&#x3C;br/>\n    Number of latest block: ${data.headerNumber}&#x3C;br/>\n    Now: ${new Date(Number(data.now.toString())).toISOString()}&#x3C;br />\n  `;\n}\n</code></pre>\n<p>Here we just create a simple response with the collected data.\nAfter the server has successfully restarted you can open <a href=\"http://localhost:3000/\">http://localhost:3000/</a> and see the result:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 498px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c302a32db3aac5f706d70a57bab04715/79e1b/result.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.24324324324324%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABoklEQVQoz22R627aQBSEef8XSn/EBgoGfMO7tsE24BvBKWCqRkooEcV8lVelTVtGGh1ptWc0Z6bzdjxyuVwUz+czp9OJ5nrlfP5B0zTq/eO8Xq9/scVttugYoxG6pmGZE9I049PDA4Hv0+t/Rtd79Lpd+v0elm1zaf4s3vBRTAkukgV5nrN+2vD1cKDabNhut3x7eWG5XJFnGVVVsd/XlOWap/WG5+cv7La7+w6FJ7BtGxnMkJ5gPBrjS59VmjIYDrFMEykkjuUwNMbojzp6t485Mbk0zf+CtuUwmZhEcaKcWraDkBLhecphyyzL0DSde/g3z85sNifLc4qiUKfmeUEcxyyXC3VmXe8pi5KiKHl9e1Wl7Xc76n2tSrrxt6BtWTiui/ao4bpTsiwlS3OmnoemdYnmIZ7rYVs2Q8NgU1WI6VTFcs9tR3iS+TyirmvVrjE0VGau4xLHCb7vI6VPEM5IkoQwCNUF7U4YBBiDgcr9ePz+6+RwzjyKORwOKqtWIIkToihitUpVrm3LaZZTliVxFKl4oihR/6QQCCE5vb8rwZ8eWZMcRTzfLAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Result\"\n        title=\"Result\"\n        src=\"/static/c302a32db3aac5f706d70a57bab04715/79e1b/result.png\"\n        srcset=\"/static/c302a32db3aac5f706d70a57bab04715/12f09/result.png 148w,\n/static/c302a32db3aac5f706d70a57bab04715/e4a3f/result.png 295w,\n/static/c302a32db3aac5f706d70a57bab04715/79e1b/result.png 498w\"\n        sizes=\"(max-width: 498px) 100vw, 498px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>The next thing that we can do is getting the balance of some account.</p>\n<p>Please add to the function <code>getSimpleData</code> the following lines:</p>\n<pre><code>  const ADDR = '5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY';\n  const now = await this.api.query.timestamp.now();\n\n  // to get balance will be used the different method depends of substrate version\n  const balance = await this.api.query.balances.freeBalance(ADDR);\n  // or this\n  // const { data } = await this.api.query.system.account(ADDR);\n  // const balance = data.free;\n  \n  return {\n    chain,\n    nodeName,\n    nodeVersion,\n    headerNumber: header.number,\n    now,\n    balance,\n  };\n}\n</code></pre>\n<p>The address <code>5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY</code> is a predefined test account for testing purpose.\nIf you are creating a substrate chain from the <a href=\"https://substrate.dev/docs/en/tutorials/creating-your-first-substrate-chain/\">tutorial</a> then you will have this account.</p>\n<p>Depends on what version of substate node you are trying to connect the function <code>account()</code> can be not defined.\nIn this case please use function <code>freeBalance()</code>.\nThe function <code>freeBalance</code> is depreciated, for now, please read more about it in <a href=\"https://polkadot.js.org/api/start/FAQ.html#my-chain-does-not-support-system-account-queries\">polkadot FAQ</a>.</p>\n<p>Also, we need to update <code>AppController</code>. Please add the line <code>Balance: ${data.balance}</code> to the returned template literal:\nThe <code>Balance</code> is a <a href=\"https://substrate.dev/docs/en/development/module/#what-is-a-pallet\">Pallet</a> defines a cryptocurrency for blockchain.</p>\n<pre><code>@Get()\nasync getHello(): Promise&#x3C;string> {\n  const data = await this.appService.getSimpleData();\n\n  return `\n    Chain: ${data.chain}&#x3C;br/>\n    Node name: ${data.nodeName}&#x3C;br/>\n    Node version: ${data.nodeVersion}&#x3C;br/>\n    Number of latest block: ${data.headerNumber}&#x3C;br/>\n    Now: ${new Date(Number(data.now.toString())).toISOString()}&#x3C;br />\n    Balance: ${data.balance}\n  `;\n}\n</code></pre>\n<p>Now you could check the changes on <a href=\"http://localhost:3000/\">http://localhost:3000/</a>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 514px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/81780c392e759f18d94dded4fa20a1b0/dea13/result2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAByklEQVQoz3WS6Y7aQBCEef/32QBRuBy8WXP4GgMG2+ADbGwjAdoAfxa+yBORJdlNS61pTatLVd1V2+/3xHFMlmUcj0dZ59ucXVmySTOKPJe52+14e7tyu924Xn+/VVTvva6iluc5QgieVZUwDJnNXGzLYjab8aINee6rDAYazmTCw9wfsH+jtk4S9LGBbpgEwRLTMLBMk7IsMQyTwXBAFIVEYUir1UZR+rTbHTzP/5xhutlgW7YcTpJEshXCIQgChONg2zaO4/Bd6ZNlW4qipCgKTqfTfwDXG0zTklnJn05nUt54NKIsClZhRJKsmUymH+Terh/3Wcs2KYZhIISN2v8hWS6DJe7cRRuMCAKfiS3QRzpjXWe3K1G6PaIo/nSftW2WSZme5+H7PuPxGNM0cV0X7UXDEQ6WZWNZluwvFp7cZ5wkeIuFPF5Rlg8M01QOVICHwwFh2xi6jjtfIGyB687ZpCnufM5yucRxpqzClQRT+yqKohAn63fAwPfp9boMR0M0TSNJYnmQbrdLo9GUvaenL7Rb36jXG7RbLZrNr9TrdTqdDr2ewul0fge8XC7SxJVNqv28vv7kfD5LtlVWZv8rH/7u/crwd8BfGOrbTDvIPAAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Result with balance\"\n        title=\"Result with balance\"\n        src=\"/static/81780c392e759f18d94dded4fa20a1b0/dea13/result2.png\"\n        srcset=\"/static/81780c392e759f18d94dded4fa20a1b0/12f09/result2.png 148w,\n/static/81780c392e759f18d94dded4fa20a1b0/e4a3f/result2.png 295w,\n/static/81780c392e759f18d94dded4fa20a1b0/dea13/result2.png 514w\"\n        sizes=\"(max-width: 514px) 100vw, 514px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>All code you can find in this repository: <a href=\"https://github.com/janczer/substrate-nestjs\">https://github.com/janczer/substrate-nestjs</a></p>\n<p>What next?</p>\n<p>You could take a look of polkadot API: <a href=\"https://polkadot.js.org/api/start/\">polkadot-js/api</a></p>\n<p>If you haven't run the node locally, you can try this tutorial: <a href=\"https://substrate.dev/docs/en/tutorials/creating-your-first-substrate-chain/\">Creating Your First Substrate Chain</a></p>\n<p>After that you can try to write your first contract: <a href=\"https://substrate.dev/substrate-contracts-workshop/#/\">ink! Smart Contracts Tutorial</a></p>","excerpt":"Create a sample NestJS project First of all, we should create a NestJS project.\nPlease use the nest-cli to generate the project template…","frontmatter":{"slug":null,"title":"Connecting to Substrate blockchain from NestJS","description":null,"author":"ivan","tags":["blockchain","nestjs","javascript","substrate"],"date":"2020-04-07T10:41:51.004Z","image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#f8f8f8","images":{"fallback":{"src":"/static/7dea2e39407b24384b5c0abdba707ef3/0ccb9/ivan_substrateblockchain-copy.png","srcSet":"/static/7dea2e39407b24384b5c0abdba707ef3/0c964/ivan_substrateblockchain-copy.png 300w,\n/static/7dea2e39407b24384b5c0abdba707ef3/2bdcf/ivan_substrateblockchain-copy.png 600w,\n/static/7dea2e39407b24384b5c0abdba707ef3/0ccb9/ivan_substrateblockchain-copy.png 1200w","sizes":"(min-width: 1200px) 1200px, 100vw"},"sources":[{"srcSet":"/static/7dea2e39407b24384b5c0abdba707ef3/091a1/ivan_substrateblockchain-copy.webp 300w,\n/static/7dea2e39407b24384b5c0abdba707ef3/763bf/ivan_substrateblockchain-copy.webp 600w,\n/static/7dea2e39407b24384b5c0abdba707ef3/31cc3/ivan_substrateblockchain-copy.webp 1200w","type":"image/webp","sizes":"(min-width: 1200px) 1200px, 100vw"}]},"width":1200,"height":628}}}},"timeToRead":5,"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2020-04-07-connect-to-substrate-nestjs.md"},"site":{"siteMetadata":{"siteUrl":"https://brightinventions.pl"}}},"pageContext":{"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2020-04-07-connect-to-substrate-nestjs.md"}},"staticQueryHashes":["2189233960","3181594896"]}