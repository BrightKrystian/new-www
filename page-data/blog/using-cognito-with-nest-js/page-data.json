{"componentChunkName":"component---src-templates-post-template-tsx","path":"/blog/using-cognito-with-nest-js","result":{"data":{"markdownRemark":{"html":"<p>AWS Cognito simplified the authentication, authorization and user management for you. In this post I will try to present how we can use this authentication service with your mobile app, website, and manage users.</p>\n<h1>Initial work</h1>\n<p>To get started with AWS Cognito We need to create a user pool. The user pool is a container that AWS Cognito uses to manage and hold users identify.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1fe4699a0f7d687e6e4ec8e486a22447/60708/user_pool_1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.24324324324324%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAkklEQVQoz+3Ouw4CIRAFUD7er7E38R8sfGysrDRrostjAWGgu2Yh4EploqXFCWG43AzbdkfsDh0u/RVcKQxCJnchcRt4xmVV3gshJZabMxbrE1b7HsxYC20tHBEoxmq6j8ZAaQ3lKBnde6Z4UIDxAS5EsDL0IaSSuWmWUdVmcq4IYG3B/PyEb/6z1xbf+Rf+rvAJUHK1njv3/kMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"user pool 1\"\n        title=\"user pool 1\"\n        src=\"/static/1fe4699a0f7d687e6e4ec8e486a22447/fcda8/user_pool_1.png\"\n        srcset=\"/static/1fe4699a0f7d687e6e4ec8e486a22447/12f09/user_pool_1.png 148w,\n/static/1fe4699a0f7d687e6e4ec8e486a22447/e4a3f/user_pool_1.png 295w,\n/static/1fe4699a0f7d687e6e4ec8e486a22447/fcda8/user_pool_1.png 590w,\n/static/1fe4699a0f7d687e6e4ec8e486a22447/efc66/user_pool_1.png 885w,\n/static/1fe4699a0f7d687e6e4ec8e486a22447/c83ae/user_pool_1.png 1180w,\n/static/1fe4699a0f7d687e6e4ec8e486a22447/60708/user_pool_1.png 2872w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>We are going to start with Create User Pool. In my case I don’t have user pools, so I’m going to create one.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8e74b6710ce8e5e4badd0b9e3fee11a9/39148/user_pool_2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.21621621621622%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABeklEQVQoz12RzW7TQBRG/XqwZoPEAiHehzegC8QC+hRd0AULJKARCURVbMeO7fhnPOOZO3Z/DvI0SdUujr67+O7RXE20WPxmtbziz+In2S5HW4vS+oAhL0ryojhwmMsyzF3fh87crTpDqQxRFq9RzQ5rGqyz9EZjxeG8hEy3WzZxzCaJSdI0ZJwkYTZ2wHmPEwl98UKU5juyogov6wfhap2TlD21uWGvJ5TwhNY9Uukbqn6i1lPIRgtRlucYa7EiGCco61GDBDojZGXNttiTFnvysqaua5qmpWkaROYrxlNfWyGq25bBuSCcTzwyn+FHT6cUreroupa0qPi2TLlcZVyutvyIW5LG4P1xV4geRBKkg5OAcY5xmrB+YlP1rAsF93f8yi0vz/7y5ss1b8+vefFxyYeLLdyNaHsQPojcSXpMGUfGcURrTad6uJ1Y5JrXn1e8+/qP9+drXn1acfZ9B7f+UXh84Yln8lk8M//mvFT1llINJ7rBPun/BxeLWN+RYBW5AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"user pool 2\"\n        title=\"user pool 2\"\n        src=\"/static/8e74b6710ce8e5e4badd0b9e3fee11a9/fcda8/user_pool_2.png\"\n        srcset=\"/static/8e74b6710ce8e5e4badd0b9e3fee11a9/12f09/user_pool_2.png 148w,\n/static/8e74b6710ce8e5e4badd0b9e3fee11a9/e4a3f/user_pool_2.png 295w,\n/static/8e74b6710ce8e5e4badd0b9e3fee11a9/fcda8/user_pool_2.png 590w,\n/static/8e74b6710ce8e5e4badd0b9e3fee11a9/efc66/user_pool_2.png 885w,\n/static/8e74b6710ce8e5e4badd0b9e3fee11a9/c83ae/user_pool_2.png 1180w,\n/static/8e74b6710ce8e5e4badd0b9e3fee11a9/39148/user_pool_2.png 2876w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Here you are given two options to select from, let's select <em>Review defaults</em>. Make sure to provide a pool name as well.</p>\n<p>Next, we need to create an app client. The app client is the client that our NestJS server will be communicating with. Make sure to tick Enable sign-in API for server-based authentication for our NodeJS server access Cognito user pool for authentication. App clients can be created after the generation of user pools as well. So, if you forget to add an app client when the creation of the user pool - do not worry, you can create a new one again.</p>\n<p>Let's take a look at the overview of the settings, it should look like mine.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/871cb398fd0908c5164bc03aec6a4bbb/b7a14/user_pool_overview.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.2972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABJ0lEQVQoz42SSW7DMAxFff9z9RxdNEDiVIgnkRJpyf4F6QFu0EUXD5Yl6HEQm9v9gWcI6McRlBIis39Tzg4xb2vJ594BJztPmIicPjKae9uinyYkURcZWRUrgL7vEF4dWCvqsmB5Y11XlFrBJt9pno8baOpAiX3jENZaEUJA6EcMuWAu1SX1gv3PpZyJGE2MA5hG8EUoqiil4NG2+A4BkaKfyR7Isl/W1TO0QHbnzJCzgJz8K8OUEgbr6zhiJsLMBkOyIKeMooKqglnV7x7SxhcHh1DEy7H+xClCdqFehbIJdRce95trQw9hEvGSRQRDJJBWaN0exoJckXl+L/lvofXKhTYBeQtgD1DeEP2HkH3uBJwTRmKICr5ehI/Pbp9Jcaw1Fuwq/AHhW7tYxXpHQAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"user pool overview\"\n        title=\"user pool overview\"\n        src=\"/static/871cb398fd0908c5164bc03aec6a4bbb/fcda8/user_pool_overview.png\"\n        srcset=\"/static/871cb398fd0908c5164bc03aec6a4bbb/12f09/user_pool_overview.png 148w,\n/static/871cb398fd0908c5164bc03aec6a4bbb/e4a3f/user_pool_overview.png 295w,\n/static/871cb398fd0908c5164bc03aec6a4bbb/fcda8/user_pool_overview.png 590w,\n/static/871cb398fd0908c5164bc03aec6a4bbb/efc66/user_pool_overview.png 885w,\n/static/871cb398fd0908c5164bc03aec6a4bbb/c83ae/user_pool_overview.png 1180w,\n/static/871cb398fd0908c5164bc03aec6a4bbb/b7a14/user_pool_overview.png 2864w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h1>Creating TypeScript NestJS Server</h1>\n<p>Ok, once we have completed the first part of the post which was creating a User Pool in Amazon Cognito, we can switch to creating the NestJS server which will use the Amazon Cognito user pool to authenticate users.</p>\n<p>The easiest way to set up the environment is to run commands to initialize the Nest app and allow us to install the required packages.</p>\n<p>I describe using npm to install packages, including the Nest CLI. Install the CLI globally using the <code>npm install -g</code> command (see the note above for details about global installs).</p>\n<p>So, we are adding the Nest CLI package globally:</p>\n<pre><code class=\"language-text\">npm install -g @nestjs/cli\n</code></pre>\n<p>To create, build and run a new basic Nest project in the development mode, go to the folder that should be the parent of your new project, and run the following commands:</p>\n<pre><code class=\"language-text\">nest new simple-app\ncd simple-app\nnpm run start:dev\n</code></pre>\n<p>In your browser open <code>http://localhost:3000</code> to see a new application running. The app will automatically recompile and reload when you change any of the source files.</p>\n<h1>Implement authentication</h1>\n<p>We are going to implement three functions in our NodeJS server application that authenticate the user:</p>\n<ul>\n<li>Sign in</li>\n<li>Sign up</li>\n<li>Token Validation (bonus, as an Authentication middleware)\nFor each function we will need separate API endpoints in our server as well. Let’s create an <code>auth.controller</code> to handle incoming requests.</li>\n</ul>\n<p>For that purpose we are going to use <em>NestCLI</em> to generate the <code>auth.module</code>, <code>auth.controller</code> and <code>auth.service</code>.</p>\n<pre><code class=\"language-text\">nest generate controller auth\nnest generate module auth\nnest generate service auth\n</code></pre>\n<p>The Nest CLI automatically will generate the auth folder with files and add it to the existing app module.</p>\n<p>The next step is to add a package to help us reach the Cognito SDK which will be going to be used for requests to Cognito API</p>\n<p><code>npm install amazon-cognito-identity-js --save</code></p>\n<p>In <code>auth.service</code> we define the <em>CognitoUserPool</em> by giving generated <code>userPoolId</code>, <code>appClientId</code>. For safety reasons, it's good to store them in the config file. Then I've added the function for <code>register</code> and <code>authenticate</code>. </p>\n<pre><code>import { AuthConfig } from './auth.config';\nimport { Inject, Injectable } from '@nestjs/common';\nimport {\n  AuthenticationDetails,\n  CognitoUser,\n  CognitoUserAttribute,\n  CognitoUserPool,\n  ICognitoUserPoolData,\n} from 'amazon-cognito-identity-js';\nimport { AuthCredentialsDto, AuthRegisterDto } from './auth.interface';\n\nconst poolData: ICognitoUserPoolData = {\n  UserPoolId: '{ userPoolId }',\n  ClientId: '{clientId}',\n};\nconst userPool = new CognitoUserPool(poolData);\n\n@Injectable()\nexport class AuthService {\n  private userPool: CognitoUserPool;\n  constructor(\n    @Inject('AuthConfig')\n    private readonly authConfig: AuthConfig,\n  ) {\n    this.userPool = new CognitoUserPool({ UserPoolId: this.authConfig.UserPoolId, ClientId: this.authConfig.ClientId });\n  }\n\n  get secretKey() {\n    return this.authConfig.secretKey;\n  }\n\n  async register(authRegisterRequest: AuthRegisterDto) {\n    const { name, email, password } = authRegisterRequest;\n    return new Promise(((resolve, reject) => {\n      return this.userPool.signUp(name, password, [new CognitoUserAttribute({ Name: 'email', Value: email })], null, (err, result) => {\n        if (!result) {\n          reject(err);\n        } else {\n          resolve(result.user);\n        }\n      });\n    }));\n  }\n\n  async authenticateUser(user: AuthCredentialsDto) {\n    const { name, password } = user;\n    const authenticationDetails = new AuthenticationDetails({\n      Username: name,\n      Password: password,\n    });\n    const userData = {\n      Username: name,\n      Pool: userPool,\n    };\n    const newUser = new CognitoUser(userData);\n    return new Promise(((resolve, reject) => {\n      return newUser.authenticateUser(authenticationDetails, {\n        onSuccess: (result) => {\n          resolve(result);\n        },\n        onFailure: ((err) => {\n          reject(err);\n        }),\n      });\n    }));\n  }\n}\n</code></pre>\n<p>Let's now import the following function in our <code>auth.controller</code> which will receive the request and handle it.</p>\n<pre><code>import { BadRequestException, Body, Controller, Post } from '@nestjs/common';\nimport { AuthCredentialsDto, AuthRegisterDto } from './auth.interface';\nimport { AuthService } from './auth.service';\n\n@Controller('auth')\nexport class AuthController {\n  constructor(private readonly authService: AuthService) {}\n\n  @Post('register')\n  async register(@Body() AuthRegisterDto: AuthRegisterDto) {\n    if (\n      AuthRegisterDto.password.length &#x3C; 8 ||\n      !/[a-z]/.test(AuthRegisterDto.password) ||\n      !/[A-Z]/.test(AuthRegisterDto.password) ||\n      !/[0-9]/.test(AuthRegisterDto.password)\n    ) {\n      throw new BadRequestException('Password requirements not met.');\n    }\n    try {\n      return await this.authService.register(AuthRegisterDto);\n    } catch (e) {\n      throw new BadRequestException(e.message);\n    }\n  }\n  @Post('authenticate')\n  async authenticate(@Body() authenticateRequest: AuthCredentialsDto) {\n    try {\n      return await this.authService.authenticateUser(authenticateRequest);\n    } catch (e) {\n      throw new BadRequestException(e.message);\n    }\n  }\n}\n</code></pre>\n<p>I have added two endpoints:</p>\n<ul>\n<li>register - API endpoint to register user</li>\n<li>authenticate - API endpoint to authenticate user </li>\n</ul>\n<h6>Please note that in Cognito we add requirements according to which password should have at least 8 characters, in my example, I have added some validation at the controller level.</h6>\n<p>Our Dto's interface declaration looks like:</p>\n<pre><code>export interface AuthRegisterDto {\n  email: string;\n  password: string;\n  name: string;\n}\n\nexport interface AuthCredentialsDto {\n  password: string;\n  name: string;\n}\n</code></pre>\n<h2>Bonus: Token Validation</h2>\n<p>For token validation we are going to use extra features from <em>NestJS</em>. For this purpose we are using <em>Guards</em>. </p>\n<p>We are going to start from install required packages:</p>\n<pre><code class=\"language-text\">npm i --save @nestjs/jwt @nestjs/passport passport passport-jwt\n</code></pre>\n<p>Then we are going to create a file called <code>jwt.strategy.ts</code> and add the following code:</p>\n<pre><code>import { ExtractJwt, Strategy } from 'passport-jwt';\nimport { PassportStrategy } from '@nestjs/passport';\nimport { Injectable, UnauthorizedException } from '@nestjs/common';\nimport { ClaimVerifyResult, handler } from './jwt.verify';\nimport { AuthService } from './auth.service';\n\n@Injectable()\nexport class JwtStrategy extends PassportStrategy(Strategy) {\n  constructor(private readonly authService: AuthService) {\n    super({\n      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),\n      secretOrKey: authService.secretKey,\n    });\n  }\n\n  public async validate(\n    payload: any,\n    done: (err: Error | null, result: ClaimVerifyResult) => void,\n  ) {\n    const userInfo = await handler(payload);\n    if (!userInfo) {\n      return done(new UnauthorizedException(), null);\n    }\n    done(null, userInfo);\n  }\n}\n</code></pre>\n<p>The following code extend the <em>PassportStrategy</em> package and grab the <em>Baerer token</em> from the headers and pass it to the function <code>validate</code>. </p>\n<p>Our function <code>validate</code> uses the <code>handler</code> to decode the <code>jwt token</code>. The handler is the implementation of verifying <em>JWT Token</em> with Cognito.</p>\n<pre><code>import {promisify} from 'util';\nimport * as Axios from 'axios';\nimport * as jsonwebtoken from 'jsonwebtoken';\nimport jwkToPem from 'jwk-to-pem';\n\nexport interface ClaimVerifyRequest {\n  readonly token?: string;\n}\n\nexport interface ClaimVerifyResult {\n  readonly userName: string;\n  readonly clientId: string;\n  readonly isValid: boolean;\n  readonly error?: any;\n}\n\ninterface TokenHeader {\n  kid: string;\n  alg: string;\n}\ninterface PublicKey {\n  alg: string;\n  e: string;\n  kid: string;\n  kty: string;\n  n: string;\n  use: string;\n}\ninterface PublicKeyMeta {\n  instance: PublicKey;\n  pem: string;\n}\n\ninterface PublicKeys {\n  keys: PublicKey[];\n}\n\ninterface MapOfKidToPublicKey {\n  [key: string]: PublicKeyMeta;\n}\n\ninterface Claim {\n  token_use: string;\n  auth_time: number;\n  iss: string;\n  exp: number;\n  username: string;\n  client_id: string;\n}\n\nconst cognitoPoolId = '{cognitoPoolId}';\nif (!cognitoPoolId) {\n  throw new Error('env var required for cognito pool');\n}\nconst cognitoIssuer = `https://cognito-idp.us-east-1.amazonaws.com/${cognitoPoolId}`;\n\nlet cacheKeys: MapOfKidToPublicKey | undefined;\nconst getPublicKeys = async (): Promise&#x3C;MapOfKidToPublicKey> => {\n  if (!cacheKeys) {\n    const url = `${cognitoIssuer}/.well-known/jwks.json`;\n    const publicKeys = await Axios.default.get&#x3C;PublicKeys>(url);\n    cacheKeys = publicKeys.data.keys.reduce((agg, current) => {\n      const pem = jwkToPem(current);\n      agg[current.kid] = {instance: current, pem};\n      return agg;\n    }, {} as MapOfKidToPublicKey);\n    return cacheKeys;\n  } else {\n    return cacheKeys;\n  }\n};\n\nconst verifyPromised = promisify(jsonwebtoken.verify.bind(jsonwebtoken));\n\nconst handler = async (request: ClaimVerifyRequest): Promise&#x3C;ClaimVerifyResult> => {\n  let result: ClaimVerifyResult;\n  try {\n    console.log(`user claim verfiy invoked for ${JSON.stringify(request)}`);\n    const token = request.token;\n    const tokenSections = (token || '').split('.');\n    if (tokenSections.length &#x3C; 2) {\n      throw new Error('requested token is invalid');\n    }\n    const headerJSON = Buffer.from(tokenSections[0], 'base64').toString('utf8');\n    const header = JSON.parse(headerJSON) as TokenHeader;\n    const keys = await getPublicKeys();\n    const key = keys[header.kid];\n    if (key === undefined) {\n      throw new Error('claim made for unknown kid');\n    }\n    const claim = await verifyPromised(token, key.pem) as Claim;\n    const currentSeconds = Math.floor( (new Date()).valueOf() / 1000);\n    if (currentSeconds > claim.exp || currentSeconds &#x3C; claim.auth_time) {\n      throw new Error('claim is expired or invalid');\n    }\n    if (claim.iss !== cognitoIssuer) {\n      throw new Error('claim issuer is invalid');\n    }\n    if (claim.token_use !== 'access') {\n      throw new Error('claim use is not access');\n    }\n    console.log(`claim confirmed for ${claim.username}`);\n    result = {userName: claim.username, clientId: claim.client_id, isValid: true};\n  } catch (error) {\n    result = {userName: '', clientId: '', error, isValid: false};\n  }\n  return result;\n};\n\nexport {handler};\n</code></pre>\n<p>In case you want to check the decoded jwt you can check <a href=\"https://jwt.io/\">this</a> out. More about verifying JWT in Cognito User Pool you can find <a href=\"https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-tokens-verifying-a-jwt.html\">here.</a></p>\n<p>When you want to use the <em>Authentication Guard</em>. Guards have a single responsibility. They determine whether a given request will be handled by the route handler or not, depending on certain conditions (like permissions, roles, ACLs, etc.) present at run-time. This is often referred to as authorization. Authorization (and its cousin, authentication, with which it usually collaborates) has typically been handled by middleware in traditional Express applications. Middleware is a fine choice for authentication, since things like token validation and attaching properties to the request object are not strongly connected with a particular route context (and its metadata).</p>\n<p>We need to use <a href=\"https://docs.nestjs.com/guards\">AuthGuard</a> and use Decorator <em>@UseGuards(AuthGuard)</em>. More about decorators you can find <a href=\"https://docs.nestjs.com/custom-decorators\">here</a>.</p>\n<h2>It’s showtime!</h2>\n<p>The above code is a minimalistic version for NestJS authentication using Cognito User Pools. Now it's time for doing some tests.</p>\n<h3>1. Register</h3>\n<p>I used <em>Postman</em> to send the request. In <em>@Body</em> I included email, password, name. A created successful response will contain:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8746cefc1016a6e81b57da7179c14d2a/e3829/register.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.486486486486484%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA6ElEQVQoz4WQ227DIBAF8/+f2TZt7EAdLgssGKay06gXRfLDeWClMzvLKdeKxoBYQ0wFJ4Xa2p4xOvCd0ff3UU66FfuKvJ/xxjL7wtkKb1YISSm1kUqlthUYhzllVQYD9Y40T3wuno/ZMRm/226wkO/gzfTQMKrSkiDWorkwtDBqoVdl7f3P9scXPMo/s1+GsdzL6TojMWGiMrvMIkrMFSeKT0r/B38GuwNVqcETXl9wl4nLfGNaEsYlslaSNqTU/fTNeIP0I8MmQjZXgo/Ym2B8xrjMLRaWWLA+8xkyMesO38zbuj4FfgHUbSR2BFAp/AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"register\"\n        title=\"register\"\n        src=\"/static/8746cefc1016a6e81b57da7179c14d2a/fcda8/register.png\"\n        srcset=\"/static/8746cefc1016a6e81b57da7179c14d2a/12f09/register.png 148w,\n/static/8746cefc1016a6e81b57da7179c14d2a/e4a3f/register.png 295w,\n/static/8746cefc1016a6e81b57da7179c14d2a/fcda8/register.png 590w,\n/static/8746cefc1016a6e81b57da7179c14d2a/efc66/register.png 885w,\n/static/8746cefc1016a6e81b57da7179c14d2a/e3829/register.png 1077w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Then we can check also in our app in Cognito that the User has been created:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2d06781d106d8e8f6090937e6cf59600/d2a60/registered_cognito.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.24324324324324%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABfUlEQVQoz32SS24UQRBE+/5X8AJxB684AUjsYIPAC8uj6elfdXX9f12BIu0xiAWLkKpKmZEvsnuw1mDZdrzcVuScEFNCqxm9FfSWgVZw1oyYXxVS+q+GUAEVGmxq2EKDLx2ffih8+DLi49cJD59HPH5f4L1HCAGlVNRakUtBzlnOhSoFKRcMxgUo4xFShtIGxjo8XTf8mi2+Pc/4ORk8jQrbtolpjBHWWpznid67nJnqfh+0T5iOAOcctN6lUasNvSTk4AA0iZxSEgqaLssCpZTcj+OQu9YarTUMJlZMtsB5j8Mc2LUWcWqIEe08pVAIzlMIOXRdVzEkyLKufwyVL3jRWaLu+455WWQiG0nDGO+Gvcseb7cbxnGUHRpjcL1eZQBrBpcKNpfhQ5B9HIeRIkakKc24eIpnvpGGuq+AIOwRQpo97wmHsRJlmiZM8yyNjPMvIQ1IR0oS0vhyuWCe51fCkCtMLELEOGygyttvQbO/xTcOYhrW3L8635jiN5Avtae6irIGAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"registered cognito\"\n        title=\"registered cognito\"\n        src=\"/static/2d06781d106d8e8f6090937e6cf59600/fcda8/registered_cognito.png\"\n        srcset=\"/static/2d06781d106d8e8f6090937e6cf59600/12f09/registered_cognito.png 148w,\n/static/2d06781d106d8e8f6090937e6cf59600/e4a3f/registered_cognito.png 295w,\n/static/2d06781d106d8e8f6090937e6cf59600/fcda8/registered_cognito.png 590w,\n/static/2d06781d106d8e8f6090937e6cf59600/d2a60/registered_cognito.png 807w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3>2. Authenticate</h3>\n<p>Again, in @Body I sent the required password and the user field. If I prepare the correct data, I will receive the user payload:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/272b3246ebf60d475bba669357ba887b/91608/login.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.75675675675676%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABnklEQVQoz4WSaW7cMAyFfX/0UL1AfnVLinQyntWbZO3W6leInkwHBdoI+PAokSZM4jWs78A5B2cMnE1gjGHmHFoKWKPhrIG98RhbYxAWg8No8emzw9PeIBiBxmqFxTkobTFyhWHWGGeNiUso4yFthHYb0gZSVbGBVLuAnCKM85DaoSlrAbBC2IDvhxkvJ4F20DiMBvteY3eVeOsU2l5h10nse0X314uk3O6q8Ou63bn2aHJOAAqkNHg9z9TsOG4cBo1JOvqzWXtS5QJpRRiP+YawHj4kNDFF5LUgSgE1MVyZxigdFTsfsdIE72f9L7W28fHW0GjI0xmngaGXlnZEO1sCfEzUPKR0//BfNEsISGtBdhZd3+E4MUxqAdcLNVrCxp+G5eOGIQZErZCiRyz5ntxG+ft8MHLKCaUkaKFwmTQG4dDNFlduaZdVL8zQW6XmL2zTnuItVyeqUzSl5Lttvuw5Wedby4nn40x8rfFJUFzfa82P42axGj8fBX6eBTVtcs7AWqCsJ39Vq1TaQZHnqh4erPRO+5A7T4ZquXL4DQLTTP79DNqfAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"login\"\n        title=\"login\"\n        src=\"/static/272b3246ebf60d475bba669357ba887b/fcda8/login.png\"\n        srcset=\"/static/272b3246ebf60d475bba669357ba887b/12f09/login.png 148w,\n/static/272b3246ebf60d475bba669357ba887b/e4a3f/login.png 295w,\n/static/272b3246ebf60d475bba669357ba887b/fcda8/login.png 590w,\n/static/272b3246ebf60d475bba669357ba887b/efc66/login.png 885w,\n/static/272b3246ebf60d475bba669357ba887b/c83ae/login.png 1180w,\n/static/272b3246ebf60d475bba669357ba887b/91608/login.png 1251w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3>3. Validation</h3>\n<p>For the test purposes I have added the <em>Guard</em> for the demo route. If I don't include the <em>Authorization</em> header with a token, the server will throw <code>UnauthorizedException</code> and in the client I will receive:</p>\n<pre><code>{\n    \"statusCode\": 401,\n    \"error\": \"Unauthorized\"\n}\n</code></pre>\n<p>When we add in a proper format the token <em>Bearer {token}</em> the <em>Guard</em> which will determine that the token is valid or not, and will allow the route to handle the request.</p>\n<h2>Summary</h2>\n<p>I think that more and more developers will use the IaaS (infrastructure as a service) and move logic outside the backend. What is great, in AWS you can also move all the logic with verifying the JWT to <em>LAMBDA</em> which can be triggered before sign-up and authentication (we can customize these workflows in the user pool settings).</p>\n<p>Cognito is a great service from AWS. I'm using it always when I have an opportunity to do it.</p>","excerpt":"AWS Cognito simplified the authentication, authorization and user management for you. In this post I will try to present how we can use this…","frontmatter":{"slug":null,"title":"Using AWS Cognito with NestJS","description":null,"author":"patryk","tags":["aws","cognito","backend","nestjs","nodejs"],"date":"2020-01-04T20:05:28.083Z","image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#080808","images":{"fallback":{"src":"/static/fd92e66110e22e7f55e21d5982c43f7a/ae678/amazon-cognito.png","srcSet":"/static/fd92e66110e22e7f55e21d5982c43f7a/bc16c/amazon-cognito.png 226w,\n/static/fd92e66110e22e7f55e21d5982c43f7a/b8c51/amazon-cognito.png 452w,\n/static/fd92e66110e22e7f55e21d5982c43f7a/ae678/amazon-cognito.png 903w","sizes":"(min-width: 903px) 903px, 100vw"},"sources":[{"srcSet":"/static/fd92e66110e22e7f55e21d5982c43f7a/0e77a/amazon-cognito.webp 226w,\n/static/fd92e66110e22e7f55e21d5982c43f7a/fcc05/amazon-cognito.webp 452w,\n/static/fd92e66110e22e7f55e21d5982c43f7a/c7597/amazon-cognito.webp 903w","type":"image/webp","sizes":"(min-width: 903px) 903px, 100vw"}]},"width":903,"height":282}}}},"timeToRead":9,"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2020-01-04-using-cognito-with-nest-js.md"},"site":{"siteMetadata":{"siteUrl":"https://brightinventions.pl"}}},"pageContext":{"fileAbsolutePath":"/home/runner/work/new-www/new-www/src/mdData/blog/2020-01-04-using-cognito-with-nest-js.md"}},"staticQueryHashes":["2189233960","3181594896"]}